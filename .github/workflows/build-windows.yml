name: Build Windows Executables

on:
  workflow_dispatch:  # Allow manual trigger
  push:
    branches:
      - main
      - 'claude/**'
    paths:
      - 'python/**'
      - 'build-python.bat'
      - '.github/workflows/build-windows.yml'

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, arm64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          cd python
          pip install -r requirements.txt
          cd ..

      - name: Check Python architecture
        run: python build/check-arch.py

      - name: Build Python executable for ${{ matrix.arch }}
        run: |
          cd python
          python -m PyInstaller ARGUS_core.spec --clean
          cd ..
        env:
          PYINSTALLER_TARGET_ARCH: ${{ matrix.arch }}

      - name: Create python-dist directory and copy onedir build
        run: |
          if (Test-Path python-dist) { Remove-Item python-dist -Recurse -Force }
          New-Item -ItemType Directory -Path python-dist -Force
          Copy-Item -Path python\dist\ARGUS_core -Destination python-dist\ARGUS_core -Recurse -Force

      - name: Upload Python executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-python-${{ matrix.arch }}
          path: python-dist/ARGUS_core/
          retention-days: 30

  build-electron:
    needs: build-windows
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, arm64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Download Python executable
        uses: actions/download-artifact@v4
        with:
          name: windows-python-${{ matrix.arch }}
          path: python-dist/ARGUS_core/

      - name: Install Node dependencies
        run: npm install

      - name: Build Electron app for Windows ${{ matrix.arch }}
        run: npx electron-builder --win --${{ matrix.arch }} --config.win.target=nsis --publish never

      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: ARGUS-Windows-${{ matrix.arch }}-installer
          path: dist/*.exe
          retention-days: 90

      - name: Display build info
        run: |
          echo "Build complete for Windows ${{ matrix.arch }}"
          dir dist\

  test-installer:
    needs: build-electron
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64]  # Test both architectures to verify compatibility
        # Note: GitHub Actions windows-latest runners are x64
        # ARM64 builds can be tested for installation but won't run natively

    steps:
      - name: Check system architecture
        run: |
          Write-Host "=== System Information ==="
          Write-Host "OS: $(Get-WmiObject -Class Win32_OperatingSystem | Select-Object -ExpandProperty Caption)"
          Write-Host "Architecture: $env:PROCESSOR_ARCHITECTURE"
          Write-Host "Processor: $(Get-WmiObject -Class Win32_Processor | Select-Object -ExpandProperty Name)"
          Write-Host "=========================="

      - name: Download installer
        uses: actions/download-artifact@v4
        with:
          name: ARGUS-Windows-${{ matrix.arch }}-installer
          path: installer/

      - name: Install Visual C++ Redistributable
        run: |
          Write-Host "Installing Visual C++ Redistributable..."
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile "vc_redist.x64.exe"
          Start-Process -FilePath "vc_redist.x64.exe" -ArgumentList "/install", "/quiet", "/norestart" -Wait
          Write-Host "VC++ Redistributable installed"

      - name: Install ARGUS silently
        run: |
          $installer = Get-ChildItem installer\*.exe | Select-Object -First 1
          Write-Host "Installing: $($installer.FullName)"
          Start-Process -FilePath $installer.FullName -ArgumentList "/S" -Wait
          Write-Host "Installation complete"

      - name: Check installation
        run: |
          $installPath = "$env:LOCALAPPDATA\Programs\ARGUS"
          Write-Host "Checking installation at: $installPath"

          if (Test-Path "$installPath\ARGUS.exe") {
            Write-Host "[OK] ARGUS.exe found"
          } else {
            Write-Host "[ERROR] ARGUS.exe not found!"
            exit 1
          }

          if (Test-Path "$installPath\resources\python\ARGUS_core.exe") {
            Write-Host "[OK] Python exe found"
          } else {
            Write-Host "[ERROR] Python exe not found!"
            exit 1
          }

          if (Test-Path "$installPath\resources\python\_internal") {
            $dllCount = (Get-ChildItem "$installPath\resources\python\_internal").Count
            Write-Host "[OK] _internal directory found with $dllCount files"
          } else {
            Write-Host "[ERROR] _internal directory not found!"
            exit 1
          }

          if (Test-Path "$installPath\resources\python\_internal\python311.dll") {
            $size = (Get-Item "$installPath\resources\python\_internal\python311.dll").Length
            Write-Host "[OK] python311.dll found, size: $size bytes"
          } else {
            Write-Host "[ERROR] python311.dll not found!"
            exit 1
          }

      - name: Test Python executable directly
        run: |
          $pythonExe = "$env:LOCALAPPDATA\Programs\ARGUS\resources\python\ARGUS_core.exe"
          Write-Host "Testing Python executable..."
          Write-Host "Working directory: $env:LOCALAPPDATA\Programs\ARGUS\resources\python"

          cd "$env:LOCALAPPDATA\Programs\ARGUS\resources\python"

          $output = & $pythonExe --version 2>&1
          Write-Host "Output: $output"

          if ($LASTEXITCODE -eq 0) {
            Write-Host "[OK] Python executable works!"
          } else {
            Write-Host "[ERROR] Python executable failed with exit code: $LASTEXITCODE"
            Write-Host "This indicates a DLL loading problem"
            exit 1
          }

      - name: Test list-templates command
        run: |
          $pythonExe = "$env:LOCALAPPDATA\Programs\ARGUS\resources\python\ARGUS_core.exe"
          cd "$env:LOCALAPPDATA\Programs\ARGUS\resources\python"

          Write-Host "Testing list-templates command..."
          $output = & $pythonExe list-templates 2>&1
          Write-Host "Output: $output"

          if ($LASTEXITCODE -eq 0) {
            Write-Host "[OK] list-templates command works!"
          } else {
            Write-Host "[ERROR] list-templates failed with exit code: $LASTEXITCODE"
            exit 1
          }

      - name: Launch ARGUS GUI (headless test)
        run: |
          $argusExe = "$env:LOCALAPPDATA\Programs\ARGUS\ARGUS.exe"
          Write-Host "Launching ARGUS GUI for 10 seconds..."

          # Start ARGUS in background
          $process = Start-Process -FilePath $argusExe -PassThru

          # Wait 10 seconds for it to initialize
          Start-Sleep -Seconds 10

          # Check if process is still running (didn't crash)
          if ($process.HasExited) {
            Write-Host "[ERROR] ARGUS crashed during startup!"
            Write-Host "Exit code: $($process.ExitCode)"
            exit 1
          } else {
            Write-Host "[OK] ARGUS launched successfully and is running!"
            # Kill the process
            Stop-Process -Id $process.Id -Force
            Write-Host "[OK] ARGUS stopped cleanly"
          }

      - name: Capture ARGUS logs
        if: always()
        run: |
          # Check for any log files created
          $appData = "$env:APPDATA\ARGUS"
          if (Test-Path $appData) {
            Write-Host "ARGUS app data found at: $appData"
            Get-ChildItem $appData -Recurse | ForEach-Object { Write-Host $_.FullName }
          } else {
            Write-Host "No ARGUS app data directory found"
          }

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.arch }}
          path: |
            ${{ env.LOCALAPPDATA }}\Programs\ARGUS\README-DLL-Issues.txt
            ${{ env.APPDATA }}\ARGUS\**\*.log
          retention-days: 7
