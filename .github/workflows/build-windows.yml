name: Build Windows Executables

on:
  workflow_dispatch:  # Allow manual trigger
  push:
    branches:
      - main
      - 'claude/**'
    paths:
      - 'python/**'
      - 'build-python.bat'
      - '.github/workflows/build-windows.yml'

jobs:
  build-x64:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          cd python
          pip install -r requirements.txt
          cd ..

      - name: Check Python architecture
        run: python build/check-arch.py

      - name: Build Python executable for x64
        run: |
          cd python
          python -m PyInstaller ARGUS_core.spec --clean
          cd ..
        env:
          PYINSTALLER_TARGET_ARCH: x64

      - name: Create python-dist directory and copy onedir build
        run: |
          if (Test-Path python-dist) { Remove-Item python-dist -Recurse -Force }
          New-Item -ItemType Directory -Path python-dist -Force
          Copy-Item -Path python\dist\ARGUS_core -Destination python-dist\ARGUS_core -Recurse -Force

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Node dependencies
        run: npm install

      - name: Build Electron app for Windows x64
        run: npx electron-builder --win --x64 --config.win.target=nsis --publish never

      - name: Upload Windows x64 installer
        uses: actions/upload-artifact@v4
        with:
          name: ARGUS-Windows-x64-installer
          path: dist/*.exe
          retention-days: 90

      - name: Display build info
        run: |
          echo "Build complete for Windows x64"
          dir dist\
